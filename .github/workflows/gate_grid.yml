name: gate-grid

on:
  workflow_dispatch:
    inputs:
      profit_target:
        description: "profit target (e.g. 0.10)"
        required: true
        default: "0.10"
      max_days:
        description: "max holding days H (e.g. 40)"
        required: true
        default: "40"

      # ✅ 분리: Tail label용 stop level
      tail_stop_level:
        description: "TAIL label stop level for p_tail (e.g. -0.10)"
        required: true
        default: "-0.10"

      # ✅ 분리: Engine용 stop level (시뮬 손절)
      engine_stop_level:
        description: "ENGINE stop level for simulator (e.g. -0.10)"
        required: true
        default: "-0.10"

      p_tail_thresholds:
        description: "comma-separated p_tail thresholds (e.g. 0.10,0.20,0.30)"
        required: true
        default: "0.10,0.20,0.30"
      utility_quantiles:
        description: "comma-separated utility quantiles (e.g. 0.60,0.75,0.90)"
        required: true
        default: "0.60,0.75,0.90"
      ps_mins:
        description: "comma-separated p_success minimum cutoffs (e.g. 0.50,0.60,0.70)"
        required: true
        default: "0.00,0.50,0.60,0.70"
      rank_metrics:
        description: "comma-separated rank metric (utility|ret_score|p_success). e.g. utility,ret_score"
        required: true
        default: "utility,ret_score"
      lambda_tail:
        description: "utility tail penalty lambda (single float, e.g. 0.05)"
        required: true
        default: "0.05"

      rebuild_all:
        description: "true to rebuild prices/features/labels/models from scratch"
        required: true
        default: "true"

      dedup_picks:
        description: "true=dedupe picks (skip duplicate hashes), false=run all"
        required: true
        default: "false"

  schedule:
    - cron: "10 23 * * *"

jobs:
  grid:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      PROFIT_TARGET: ${{ github.event.inputs.profit_target || '0.10' }}
      MAX_DAYS: ${{ github.event.inputs.max_days || '40' }}

      # ✅ 분리된 STOP_LEVEL 2개
      TAIL_STOP_LEVEL: ${{ github.event.inputs.tail_stop_level || '-0.10' }}
      ENGINE_STOP_LEVEL: ${{ github.event.inputs.engine_stop_level || '-0.10' }}

      P_TAIL_THRESHOLDS: ${{ github.event.inputs.p_tail_thresholds || '0.10,0.20,0.30' }}
      UTILITY_QUANTILES: ${{ github.event.inputs.utility_quantiles || '0.60,0.75,0.90' }}
      PS_MINS: ${{ github.event.inputs.ps_mins || '0.00,0.50,0.60,0.70' }}
      RANK_METRICS: ${{ github.event.inputs.rank_metrics || 'utility,ret_score' }}
      LAMBDA_TAIL: ${{ github.event.inputs.lambda_tail || '0.05' }}

      REBUILD_ALL: ${{ github.event.inputs.rebuild_all || 'false' }}

      PRICE_START: "2015-02-21"
      GATE_MODES: "none,tail,utility,tail_utility"

      ENABLE_TRAILING: "true"
      TP1_FRAC: "1.00"
      TRAIL_STOPS: "0.08,0.10,0.12"

      TOPK_CONFIGS: "1|1.0"
      MAX_LEVERAGE_PCT: "1.00"

      OUT_DIR: "data/signals"
      EXCLUDE_TICKERS: "SPY,^VIX"
      REQUIRE_FILES: "data/features/features_scored.parquet,app/model.pkl,app/scaler.pkl"

      DEDUP_PICKS: ${{ github.event.inputs.dedup_picks || 'true' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pandas numpy yfinance pyarrow scikit-learn joblib
          fi

      - name: Ensure folders
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data/raw data/features data/labels data/signals data/meta app scripts data/_backup

      - name: Set env keys (LABEL_KEY + MAX_EXTEND_DAYS auto)
        shell: bash
        run: |
          set -euo pipefail

          PT100="$(python - "$PROFIT_TARGET" <<'PY'
          import sys
          pt=float(sys.argv[1])
          print(int(round(pt*100)))
          PY
          )"

          # ✅ LABEL_KEY는 “엔진 H/pt” 기준으로 유지. (tail/engine stop이 달라도 동일 태그로 묶고 싶으면 이렇게)
          echo "LABEL_KEY=pt${PT100}_h${MAX_DAYS}" >> "$GITHUB_ENV"

          MAX_EX="$(python - "$MAX_DAYS" <<'PY'
          import sys
          H=int(float(sys.argv[1]))
          print(max(1, H//2))
          PY
          )"
          echo "MAX_EXTEND_DAYS=${MAX_EX}" >> "$GITHUB_ENV"

      - name: Prepare required files (10y only + partial rebuild)
        shell: bash
        run: |
          set -euo pipefail
          echo "[INFO] PROFIT_TARGET=$PROFIT_TARGET MAX_DAYS=$MAX_DAYS"
          echo "[INFO] TAIL_STOP_LEVEL=$TAIL_STOP_LEVEL ENGINE_STOP_LEVEL=$ENGINE_STOP_LEVEL"
          echo "[INFO] LABEL_KEY=$LABEL_KEY MAX_EXTEND_DAYS=$MAX_EXTEND_DAYS"

          if [ "${REBUILD_ALL}" = "true" ]; then
            rm -rf data/raw/* data/features/* data/labels/* app/* data/signals/* data/meta/* || true
          fi

          python scripts/universe.py
          if [ ! -f data/raw/prices.parquet ] && [ ! -f data/raw/prices.csv ]; then
            python scripts/fetch_prices.py --include-extra --reset --force-full --start "${PRICE_START}"
          else
            python scripts/fetch_prices.py --include-extra --lookback-days 10 --start "${PRICE_START}"
          fi

          if [ ! -f data/features/features_model.parquet ] && [ ! -f data/features/features_model.csv ]; then
            python scripts/build_features.py
          else
            echo "[INFO] features_model exists -> reuse"
          fi

          # p_success labels/model (stop_level은 여기서 사실상 메타용이면, 그냥 ENGINE_STOP_LEVEL로 통일해도 되고 아무거나 써도 됨)
          if [ ! -f data/labels/labels_model.parquet ] && [ ! -f data/labels/labels_model.csv ]; then
            python scripts/build_labels.py \
              --profit-target "${PROFIT_TARGET}" \
              --max-days "${MAX_DAYS}" \
              --stop-level "${TAIL_STOP_LEVEL}"
          else
            echo "[INFO] labels_model exists -> reuse"
          fi

          if [ ! -f app/model.pkl ] || [ ! -f app/scaler.pkl ]; then
            python scripts/train_model.py
          else
            echo "[INFO] p_success model exists -> reuse"
          fi

          # ✅ Tail labels/model 은 TAIL_STOP_LEVEL을 사용
          EX_TAG="pt$(python - "$PROFIT_TARGET" <<'PY'
          import sys
          pt=float(sys.argv[1]); print(int(round(pt*100)))
          PY
          )_h${MAX_DAYS}_sl$(python - "$TAIL_STOP_LEVEL" <<'PY'
          import sys
          sl=float(sys.argv[1]); print(int(round(abs(sl)*100)))
          PY
          )_ex${MAX_EXTEND_DAYS}"

          if [ ! -f "data/labels/labels_tail_${EX_TAG}.parquet" ] && [ ! -f "data/labels/labels_tail_${EX_TAG}.csv" ]; then
            python scripts/build_tail_labels.py \
              --profit-target "${PROFIT_TARGET}" \
              --max-days "${MAX_DAYS}" \
              --stop-level "${TAIL_STOP_LEVEL}" \
              --max-extend-days "${MAX_EXTEND_DAYS}"
          else
            echo "[INFO] labels_tail exists -> reuse"
          fi

          if [ ! -f app/tail_model.pkl ] || [ ! -f app/tail_scaler.pkl ]; then
            python scripts/train_tail_model.py \
              --profit-target "${PROFIT_TARGET}" \
              --max-days "${MAX_DAYS}" \
              --stop-level "${TAIL_STOP_LEVEL}" \
              --max-extend-days "${MAX_EXTEND_DAYS}" \
            || echo "[WARN] tail training skipped (one-class target or training error)"
          else
            echo "[INFO] tail model exists -> reuse"
          fi

          # score_features (p_success/p_tail 생성)
          python scripts/score_features.py --tag "${LABEL_KEY}" --tau-h-map 30,40,50 || true

      - name: Run gate grid (predict + simulate + summarize)
        shell: bash
        run: |
          set -euo pipefail
          chmod +x scripts/run_grid_workflow.sh
          bash scripts/run_grid_workflow.sh

      - name: Upload artifacts (signals)
        uses: actions/upload-artifact@v4
        with:
          name: gate-grid-results
          path: |
            data/signals/gate_summary_*.csv
            data/signals/gate_grid_aggregate.csv
            data/signals/gate_grid_top_by_recent10y.csv
            data/signals/picks_*.csv
            data/signals/picks_meta_*.json
            data/signals/sim_engine_trades_*.parquet
            data/signals/sim_engine_curve_*.parquet
            data/features/features_scored.csv
            data/features/features_scored.parquet
          if-no-files-found: error
